@using Core.Preferences;
@using Microsoft.Extensions.Configuration.Memory
@using TabKeeper.Components.Preferences.Pages;

@page "/settings"
@inherits CoreComponent
@inject TranslateService translate
@inject ISyncLocalStorageService localStorage

<PreferenceScreenPage Screen="Preferences.Screen" />

@code {
    public static ConfigurationManager Configuration { get; } = new();

    protected override void OnInitialized()
    {
        if (Configuration.Sources.Count is 1)
        {
            Configuration.Sources.Add(new LocalStorageConfigurationProvider(localStorage));
        }

        ShellLayout.Context = new() { Title = "settings.title" | translate };

        Preferences.Screen.TitleTransformer = v => v | translate;
        Preferences.Screen.DescriptionTransformer = v => v is {} ? v | translate : v;
        Preferences.Screen.SummaryTransformer = v => v | translate;

        Preferences.Screen
            .WhenValuePreferenceChanged(Preferences.Theme)
            .Throttle(TimeSpan.FromMilliseconds(100))
            .Subscribe(p => ThemeModule.UpdateDom());

        Preferences.Screen.Initialize(Configuration);
    }
}
